<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta name="naver-site-verification" content="b0edbc1bb2667fa54c19a898e12c1a94416dd9da" />
    <meta name="google-site-verification" content="m-4-AfhCJa3w-XO85XrOn0EzN7SshBdjbR9KkLHae2c" />
    
    <meta property="og:title" content="STAY - ì‹¤ì‹œê°„ ìµëª… íˆ¬í‘œ">
    <meta property="og:description" content="ì§€ê¸ˆ ë°”ë¡œ íˆ¬í‘œë¥¼ ë§Œë“¤ê³  ì‚¬ëŒë“¤ì˜ ì†”ì§í•œ ì˜ê²¬ì„ ë“¤ì–´ë³´ì„¸ìš”.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://www.stayvote.co.kr">
    <meta property="og:image" content="https://stayvote.github.io/stay/og-image.png">
    
    <title>STAY - ì‹¤ì‹œê°„ ìµëª… íˆ¬í‘œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://openfpcdn.io/fingerprintjs/v4"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #ffffff; 
            color: #111827; 
            overflow-x: hidden; 
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: contain; 
            position: relative;
            width: 100%;
            transform-origin: top;
        }

        .glass { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(15px); border-bottom: 1px solid #f3f4f6; }
        .btn-main { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); color: white; }
        div[id^="screen-"] { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .vote-card { 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            border: 1px solid #f3f4f6;
        }
        @media (hover: hover) {
            .vote-card:hover { 
                transform: translateY(-8px); 
                box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.08);
                border-color: #6366f1;
            }
        }
        .vote-card:active { transform: scale(0.97); }

        .vote-bar { transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1); }
        #side-menu { position: fixed; top: 0; left: 0; width: 280px; height: 100%; background: white; z-index: 10001; transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 20px 0 50px rgba(0,0,0,0.1); }
        #menu-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: none; }
        input, textarea { font-size: 16px !important; background-color: #f3f4f6 !important; }
        
        #auth-modal { position: fixed; inset: 0; z-index: 20000; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.6); padding: 20px; }

        #ptr-wrap {
            position: absolute; top: -60px; left: 0; width: 100%; height: 60px;
            display: flex; align-items: center; justify-content: center;
            z-index: 1; pointer-events: none; opacity: 0;
        }
        .ptr-arrow {
            width: 26px; height: 26px;
            fill: none; stroke: #4f46e5; stroke-width: 2.5;
            stroke-linecap: round; stroke-linejoin: round;
        }

        .hp-field { position: absolute; left: -9999px; top: -9999px; opacity: 0; }
    </style>
</head>
<body>

    <input type="text" id="hp_nickname" class="hp-field" tabindex="-1" autocomplete="off">

    <div id="ptr-wrap">
        <svg class="ptr-arrow" id="ptr-icon" viewBox="0 0 24 24">
            <path d="M23 4v6h-6M1 20v-6h6"/>
            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
        </svg>
    </div>

    <div id="auth-modal">
        <div class="bg-white w-full max-w-xs p-6 rounded-[2rem] shadow-2xl space-y-4">
            <h3 id="modal-title" class="text-lg font-black text-center">í™•ì¸</h3>
            <p id="modal-desc" class="text-xs text-gray-500 text-center">ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.</p>
            <input type="password" id="modal-pw-input" placeholder="ë¹„ë°€ë²ˆí˜¸" class="w-full bg-gray-100 rounded-xl p-4 outline-none text-center">
            <div class="flex space-x-2">
                <button onclick="closeAuthModal()" class="flex-1 bg-gray-100 py-3 rounded-xl font-bold text-gray-500">ì·¨ì†Œ</button>
                <button id="modal-submit-btn" class="flex-1 btn-main py-3 rounded-xl font-bold text-white">í™•ì¸</button>
            </div>
        </div>
    </div>

    <div id="menu-overlay" onclick="toggleMenu()"></div>
    <div id="side-menu">
        <div class="p-8">
            <h3 class="text-xs font-black text-indigo-600 uppercase tracking-[0.2em] mb-10">Menu</h3>
            <nav class="space-y-2">
                <button onclick="filterByCategory('ì „ì²´')" class="w-full text-left px-5 py-4 rounded-2xl font-bold text-gray-900 hover:bg-gray-50 transition-colors">ì „ì²´ë³´ê¸°</button>
                <button onclick="showMyCreatedPolls()" class="w-full text-left px-5 py-4 rounded-2xl font-bold text-indigo-600 hover:bg-indigo-50 transition-colors">ğŸ‘¤ ë‚´ê°€ ë§Œë“  íˆ¬í‘œ</button>
                <button onclick="filterByCategory('ì‹¤ì‹œê°„ í•«')" class="w-full text-left px-5 py-4 rounded-2xl font-bold text-red-500 hover:bg-red-50 transition-colors">ğŸ”¥ ì‹¤ì‹œê°„ í•«</button>
                <div class="h-px bg-gray-100 my-4"></div>
                <button onclick="filterByCategory('ì´ìŠˆ/ë‰´ìŠ¤')" class="w-full text-left px-5 py-4 rounded-2xl font-bold text-gray-700 hover:bg-gray-50 transition-colors">ì´ìŠˆ/ë‰´ìŠ¤</button>
                <button onclick="filterByCategory('ì—°ì• /ì‹¬ë¦¬')" class="w-full text-left px-5 py-4 rounded-2xl font-bold text-gray-700 hover:bg-gray-50 transition-colors">ì—°ì• /ì‹¬ë¦¬</button>
                <button onclick="filterByCategory('ì·¨ë¯¸/ë¬¸í™”')" class="w-full text-left px-5 py-4 rounded-2xl font-bold text-gray-700 hover:bg-gray-50 transition-colors">ì·¨ë¯¸/ë¬¸í™”</button>
                <button onclick="filterByCategory('ì¼ìƒ/ì¡ë‹´')" class="w-full text-left px-5 py-4 rounded-2xl font-bold text-gray-700 hover:bg-gray-50 transition-colors">ì¼ìƒ/ì¡ë‹´</button>
            </nav>
        </div>
    </div>

    <div id="screen-main" class="flex flex-col items-center justify-center h-screen space-y-8 p-6 text-center">
        <h1 class="text-7xl font-black italic tracking-tighter text-gray-900">STAY.</h1>
        <div class="grid grid-cols-1 gap-3 w-full max-w-xs">
            <button onclick="openCreateScreen()" class="btn-main p-6 rounded-[1.5rem] font-bold text-lg clickable">ìƒˆ íˆ¬í‘œ ë§Œë“¤ê¸°</button>
            <button onclick="goSearch()" class="bg-gray-50 p-6 rounded-[1.5rem] font-bold text-lg clickable text-gray-700 border border-gray-200">ì „ì²´ íˆ¬í‘œ ëª©ë¡</button>
        </div>
    </div>

    <div id="screen-create" class="hidden min-h-screen p-6 flex flex-col items-center pt-10 bg-gray-50">
        <div class="w-full max-w-md bg-white p-8 rounded-[2rem] shadow-xl space-y-4">
            <div class="flex justify-between items-center mb-2">
                <h3 id="create-title" class="text-xl font-black italic text-indigo-600 uppercase">New Post</h3>
                <button onclick="window.history.back()" class="text-gray-400 font-bold text-[10px] p-2">BACK</button>
            </div>
            <select id="new-room-cat" class="w-full bg-gray-50 rounded-xl p-4 text-sm"><option value="ì¼ìƒ/ì¡ë‹´">ì¼ìƒ/ì¡ë‹´</option><option value="ì´ìŠˆ/ë‰´ìŠ¤">ì´ìŠˆ/ë‰´ìŠ¤</option><option value="ì—°ì• /ì‹¬ë¦¬">ì—°ì• /ì‹¬ë¦¬</option><option value="ì·¨ë¯¸/ë¬¸í™”">ì·¨ë¯¸/ë¬¸í™”</option></select>
            <input type="text" id="new-room-name" placeholder="íˆ¬í‘œ ì œëª©" class="w-full bg-gray-50 rounded-xl p-4 outline-none">
            <textarea id="new-room-desc" placeholder="ì„¤ëª… (ì„ íƒ)" rows="3" class="w-full bg-gray-50 rounded-xl p-4 text-sm outline-none resize-none"></textarea>
            <div id="pw-field-container"><input type="password" id="new-room-pw" placeholder="ì‚­ì œ ë° ìˆ˜ì • ë¹„ë°€ë²ˆí˜¸" class="w-full bg-gray-100 rounded-xl p-4 text-sm outline-none"></div>
            <div id="options-list" class="space-y-2 pt-2"></div>
            <button id="btn-add-option" onclick="addOptionField()" class="text-[10px] text-indigo-500 font-bold uppercase p-2">+ Add Option</button>
            <button id="btn-submit-create" onclick="processCreate()" class="w-full btn-main py-4 rounded-xl font-bold text-lg clickable mt-4 shadow-md">ê²Œì‹œê¸€ ì˜¬ë¦¬ê¸°</button>
        </div>
    </div>

    <div id="screen-list" class="hidden min-h-screen bg-white">
        <div class="sticky top-0 z-[100] glass p-5 flex justify-between items-center">
            <button onclick="toggleMenu()" class="p-2 font-black text-[10px]">MENU</button>
            <h2 id="current-board-name" class="text-xl font-black italic">ì „ì²´ë³´ê¸°</h2>
            <button onclick="switchScreen('screen-main')" class="text-gray-400 font-bold text-[10px]">EXIT</button>
        </div>
        <div class="p-4"><input type="text" id="search-bar" oninput="renderList()" placeholder="ì œëª© ê²€ìƒ‰..." class="w-full bg-gray-100 rounded-xl py-4 px-5 text-sm outline-none"></div>
        <div id="room-list" class="p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 bg-gray-50 min-h-screen content-start"></div>
    </div>

    <div id="screen-room" class="hidden min-h-screen bg-white">
        <div class="sticky top-0 z-[100] glass p-4 flex justify-between items-center bg-white">
            <div class="flex items-center space-x-2">
                <button id="btn-room-back" onclick="handleBack()" class="text-gray-400 p-2 font-black text-[10px]">â† BACK</button>
                <button onclick="switchScreen('screen-main')" class="text-gray-600 p-2 font-black text-[10px]">EXIT</button>
            </div>
            <button onclick="copyLink()" class="px-3 py-1 bg-indigo-50 text-indigo-600 text-[9px] font-bold rounded-full border border-indigo-100 uppercase tracking-tighter">Copy Link</button>
        </div>
        <div class="w-full max-w-md mx-auto p-6 mt-6 text-center">
            <span id="room-display-cat" class="text-[10px] font-black text-indigo-500 uppercase tracking-widest mb-2 block"></span>
            <h2 id="room-display-name" class="text-3xl font-black mb-1 italic tracking-tighter text-gray-900 leading-tight"></h2>
            <div id="room-display-date" class="text-[10px] font-bold text-gray-300 uppercase mb-6"></div>
            <p id="room-display-desc" class="text-gray-500 text-sm mb-12"></p>
            <div id="poll-display-area" class="space-y-3 mb-8"></div>
            <div class="flex space-x-2 mb-12">
                <button onclick="openAuthModal('edit')" class="flex-1 bg-gray-50 text-indigo-500 text-[10px] font-black uppercase p-4 rounded-xl border border-indigo-50 transition-colors">Edit Post</button>
                <button onclick="openAuthModal('delete')" class="flex-1 bg-gray-50 text-red-400 text-[10px] font-black uppercase p-4 rounded-xl border border-red-50">Delete Post</button>
            </div>
            <div class="pt-10 border-t border-gray-100 text-left">
                <h4 class="text-xs font-black text-gray-900 uppercase tracking-widest mb-6 px-2 text-center font-bold">Next for you</h4>
                <div id="recommend-list" class="space-y-4 pb-20"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, runTransaction, remove, get, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAgydW97uyDPNqs5VPZnSt5E-fytezqVO0",
            authDomain: "project-8611780166111781402.firebaseapp.com",
            databaseURL: "https://project-8611780166111781402-default-rtdb.firebaseio.com",
            projectId: "project-8611780166111781402"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        let currentRoomId = ""; let allRooms = []; let currentCategory = "ì „ì²´";
        let isEditMode = false;
        let myFingerprint = ""; 

        const setFingerprint = async () => {
            const fp = await FingerprintJS.load();
            const result = await fp.get();
            myFingerprint = result.visitorId;
        };
        setFingerprint();

        const isSecureAccess = () => {
            if (document.getElementById('hp_nickname').value !== "") return false; 
            return true;
        };

        // UI & ë„¤ë¹„ê²Œì´ì…˜ ë¡œì§ (ìœ ì§€)
        window.switchScreen = (id, skipPush = false, roomId = null) => {
            document.querySelectorAll('div[id^="screen-"]').forEach(s => s.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            if (id === 'screen-room' && roomId) {
                const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?id=' + roomId;
                if(!skipPush) history.pushState({ screen: id, roomId: roomId }, "", newUrl);
            } else if (id === 'screen-main') {
                const mainUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
                if(!skipPush) history.pushState({ screen: id }, "", mainUrl);
            } else {
                const stateUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '#' + id;
                if(!skipPush) history.pushState({ screen: id }, "", stateUrl);
            }
            window.scrollTo(0,0);
        };

        window.onpopstate = (e) => {
            const state = e.state;
            const hash = window.location.hash.replace('#', '');
            if (state?.screen === 'screen-room' && state.roomId) enterRoom(state.roomId, false, true);
            else if (hash === 'screen-list') switchScreen('screen-list', true);
            else if (hash === 'screen-create') openCreateScreen(true);
            else switchScreen('screen-main', true);
        };

        window.addEventListener('load', () => {
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');
            const hash = window.location.hash.replace('#', '');
            const checkData = setInterval(() => {
                if (allRooms.length > 0 || hash === 'screen-create') {
                    if (id) enterRoom(id, false, true);
                    else if (hash === 'screen-list') switchScreen('screen-list', true);
                    else if (hash === 'screen-create') openCreateScreen(true);
                    clearInterval(checkData);
                }
            }, 50);
        });

        window.openCreateScreen = (skipPush = false) => {
            isEditMode = false;
            document.getElementById('create-title').innerText = "New Post";
            document.getElementById('new-room-name').value = "";
            document.getElementById('new-room-desc').value = "";
            document.getElementById('new-room-pw').value = "";
            document.getElementById('pw-field-container').style.display = 'block';
            document.getElementById('options-list').innerHTML = "";
            addOptionField(); addOptionField();
            document.getElementById('btn-add-option').style.display = 'block';
            document.getElementById('btn-submit-create').innerText = "ê²Œì‹œê¸€ ì˜¬ë¦¬ê¸°";
            switchScreen('screen-create', skipPush);
        };

        window.copyLink = () => {
            const url = window.location.href;
            navigator.clipboard.writeText(url).then(() => { alert("íˆ¬í‘œ ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!"); });
        };

        window.handleBack = () => {
            if (history.length > 1) window.history.back();
            else switchScreen('screen-main');
        };

        window.goSearch = () => {
            currentCategory = "ì „ì²´";
            document.getElementById('search-bar').value = "";
            switchScreen('screen-list');
            refreshData();
        };

        const refreshData = () => {
            get(ref(db, 'rooms')).then(snap => {
                allRooms = snap.val() ? Object.entries(snap.val()) : [];
                renderList();
            });
        };
        refreshData();

        window.showMyCreatedPolls = () => {
            currentCategory = "ë‚´ê°€ ë§Œë“  íˆ¬í‘œ";
            toggleMenu();
            renderList();
        };

        function getTimeAgo(ts) {
            const sec = Math.floor((Date.now() - ts) / 1000);
            if (sec < 60) return "ë°©ê¸ˆ ì „";
            if (sec < 3600) return Math.floor(sec/60) + "ë¶„ ì „";
            if (sec < 86400) return Math.floor(sec/3600) + "ì‹œê°„ ì „";
            return Math.floor(sec/86400) + "ì¼ ì „";
        }
        function formatExactDate(ts) {
            const d = new Date(ts);
            return `${d.getMonth() + 1}.${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
        }

        window.renderList = () => {
            const listArea = document.getElementById('room-list');
            const query = document.getElementById('search-bar').value.toLowerCase().trim();
            listArea.innerHTML = "";
            document.getElementById('current-board-name').innerText = currentCategory;
            
            const getHotScore = (room) => {
                const total = room.poll?.options ? Object.values(room.poll.options).reduce((a, b) => a + Number(b), 0) : 0;
                const hours = (Date.now() - (room.createdAt || Date.now())) / 3600000;
                return total / Math.pow(hours + 2, 1.5);
            };
            
            const topHotIds = [...allRooms].sort((a, b) => getHotScore(b[1]) - getHotScore(a[1])).slice(0, 3).map(item => item[0]);
            
            let displayRooms = [...allRooms];
            if (currentCategory === "ì‹¤ì‹œê°„ í•«") {
                displayRooms = displayRooms.filter(([id, room]) => {
                    const total = room.poll?.options ? Object.values(room.poll.options).reduce((a, b) => a + Number(b), 0) : 0;
                    return (getHotScore(room) > 0.1 || topHotIds.includes(id)) && total > 0;
                }).sort((a, b) => getHotScore(b[1]) - getHotScore(a[1]));
            } else if (currentCategory === "ë‚´ê°€ ë§Œë“  íˆ¬í‘œ") {
                displayRooms = displayRooms.filter(([id, room]) => room.creatorFingerprint === myFingerprint);
            } else if (currentCategory !== "ì „ì²´") {
                displayRooms = displayRooms.filter(([id, room]) => (room.category || "ì¼ìƒ/ì¡ë‹´") === currentCategory);
            }
            
            const filtered = displayRooms.filter(([id, room]) => room.title.toLowerCase().includes(query));
            if (currentCategory !== "ì‹¤ì‹œê°„ í•«") filtered.sort((a,b) => (b[1].createdAt || 0) - (a[1].createdAt || 0));
            
            filtered.forEach(([id, room]) => {
                // â­ íˆ¬í‘œìˆ˜ í•©ì‚° ë¡œì§ ì¼ì¹˜í™” â­
                const totalVotes = room.poll?.options ? Object.values(room.poll.options).reduce((a, b) => Number(a) + Number(b), 0) : 0;
                const timeText = room.createdAt ? getTimeAgo(room.createdAt) : "ì˜¤ë˜ì „";
                
                const isHot = (getHotScore(room) > 0.1 || topHotIds.includes(id)) && totalVotes > 0; 
                const hotBadge = isHot ? `<span class="ml-2 inline-block text-[9px] font-black text-red-500 italic tracking-tighter border border-red-200 px-1.5 py-0.5 rounded-md bg-red-50 animate-pulse uppercase">HOT</span>` : '';
                
                const div = document.createElement('div');
                div.className = "vote-card bg-white p-6 rounded-[2rem] shadow-sm clickable hover:ring-2 hover:ring-indigo-500";
                div.onclick = () => enterRoom(id, false);
                div.innerHTML = `<div class="flex justify-between items-start mb-3"><span class="text-[9px] font-black text-indigo-500 uppercase tracking-widest">${room.category || 'ì¼ìƒ/ì¡ë‹´'}</span>${hotBadge}</div><div class="text-lg font-bold text-gray-900 mb-3 leading-tight min-h-[3rem]">${room.title}</div><div class="pt-4 border-t border-gray-50 flex justify-between items-center"><span class="text-[10px] text-gray-400 font-bold uppercase tracking-wide">${totalVotes} Votes</span><span class="text-[10px] text-gray-300 font-bold uppercase">${timeText}</span></div>`;
                listArea.appendChild(div);
            });
        };

        window.enterRoom = (id, isFromCreate = false, skipPush = false) => {
            currentRoomId = id;
            switchScreen('screen-room', skipPush, id);
            onValue(ref(db, `rooms/${id}`), snap => {
                const data = snap.val(); if(!data) return;
                document.getElementById('room-display-name').innerText = data.title;
                document.getElementById('room-display-desc').innerText = data.desc || "";
                document.getElementById('room-display-cat').innerText = data.category || "ì¼ìƒ/ì¡ë‹´";
                const timeText = data.createdAt ? `${formatExactDate(data.createdAt)} (${getTimeAgo(data.createdAt)})` : "ì˜¤ë˜ì „";
                document.getElementById('room-display-date').innerText = `POSTED ON ${timeText}`;
                renderPoll(data.poll, data.votedIPs || {});
                renderRecommendations(id);
            });
        };

        function renderRecommendations(excludeId) {
            const area = document.getElementById('recommend-list'); area.innerHTML = "";
            const recs = allRooms.filter(([id]) => id !== excludeId).sort(() => 0.5 - Math.random()).slice(0, 3);
            recs.forEach(([id, room]) => {
                const d = document.createElement('div');
                d.className = "bg-gray-50 p-5 rounded-2xl clickable border border-gray-100 hover:bg-white hover:ring-1 hover:ring-indigo-200 transition-all";
                d.onclick = (e) => { e.stopPropagation(); enterRoom(id, false); };
                d.innerHTML = `<div class="text-[8px] font-black text-indigo-400 uppercase mb-1">${room.category || 'ì¼ìƒ/ì¡ë‹´'}</div><div class="text-sm font-bold text-gray-800 leading-snug">${room.title}</div>`;
                area.appendChild(d);
            });
        }

        window.processCreate = () => {
            if(!isSecureAccess()) return alert("ë¹„ì •ìƒì ì¸ ì ‘ê·¼ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.");
            const title = document.getElementById('new-room-name').value.trim();
            const category = document.getElementById('new-room-cat').value;
            const desc = document.getElementById('new-room-desc').value.trim();
            if(!title) return alert("ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.");
            let options = {}; 
            const inputs = document.querySelectorAll('.poll-input');
            let hasOption = false;
            inputs.forEach(i => { if(i.value.trim()) { options[i.value.trim()] = 0; hasOption = true; } });
            if(!hasOption) return alert("ìµœì†Œ í•œ ê°œì˜ ì„ íƒì§€ê°€ í•„ìš”í•©ë‹ˆë‹¤.");

            if (isEditMode) {
                update(ref(db, `rooms/${currentRoomId}`), { title, category, desc, "poll/options": options }).then(() => {
                    alert("ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    isEditMode = false;
                    enterRoom(currentRoomId, true, true);
                });
            } else {
                const pw = document.getElementById('new-room-pw').value.trim();
                if(!pw) return alert("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
                const id = 'r_' + Date.now();
                set(ref(db, `rooms/${id}`), { title, pw, desc, category, poll: { options }, createdAt: Date.now(), creatorFingerprint: myFingerprint }).then(() => {
                    enterRoom(id, true, true);
                });
            }
        };

        window.openAuthModal = (type) => {
            const modal = document.getElementById('auth-modal');
            const input = document.getElementById('modal-pw-input');
            input.value = ""; modal.style.display = 'flex';
            if(type === 'edit') {
                document.getElementById('modal-title').innerText = "ìˆ˜ì • í™•ì¸";
                document.getElementById('modal-submit-btn').onclick = () => handleEditAuth();
            } else {
                document.getElementById('modal-title').innerText = "íˆ¬í‘œ ì‚­ì œ";
                document.getElementById('modal-submit-btn').onclick = () => handleDeleteAuth();
            }
        };
        window.closeAuthModal = () => { document.getElementById('auth-modal').style.display = 'none'; };
        
        const handleEditAuth = () => {
            const inputPw = document.getElementById('modal-pw-input').value.trim();
            get(ref(db, `rooms/${currentRoomId}`)).then(snap => {
                const data = snap.val();
                if(String(data.pw).trim() === inputPw) {
                    isEditMode = true; closeAuthModal(); switchScreen('screen-create');
                    document.getElementById('create-title').innerText = "Edit Post";
                    document.getElementById('new-room-name').value = data.title;
                    document.getElementById('options-list').innerHTML = "";
                    Object.entries(data.poll.options).forEach(([label, count]) => { addOptionField(label, count); });
                } else alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
            });
        };
        const handleDeleteAuth = () => {
            const inputPw = document.getElementById('modal-pw-input').value.trim();
            get(ref(db, `rooms/${currentRoomId}`)).then(snap => {
                if(String(snap.val().pw).trim() === inputPw) {
                    remove(ref(db, `rooms/${currentRoomId}`)).then(() => {
                        alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."); closeAuthModal(); switchScreen('screen-main'); refreshData();
                    });
                } else alert("í‹€ë ¸ìŠµë‹ˆë‹¤.");
            });
        };

        // --- â­ íˆ¬í‘œ í´ë¦­ ë° í† ê¸€ ë¬´ì¡°ê±´ ì‘ë™ ë¡œì§ â­ ---
        
        window.executeVote = async (label) => {
            if(!isSecureAccess()) return;
            
            const roomRef = ref(db, `rooms/${currentRoomId}`);
            const snap = await get(roomRef);
            const roomData = snap.val();
            
            if (!roomData) return;
            if (!roomData.poll) roomData.poll = { options: {} };
            if (!roomData.votedIPs) roomData.votedIPs = {};

            const currentChoice = roomData.votedIPs[myFingerprint];

            if (currentChoice === label) {
                // í† ê¸€ ì·¨ì†Œ
                roomData.poll.options[label] = Math.max(0, (Number(roomData.poll.options[label]) || 0) - 1);
                delete roomData.votedIPs[myFingerprint];
            } else if (currentChoice) {
                // ì„ íƒ ì´ë™
                roomData.poll.options[currentChoice] = Math.max(0, (Number(roomData.poll.options[currentChoice]) || 0) - 1);
                roomData.poll.options[label] = (Number(roomData.poll.options[label]) || 0) + 1;
                roomData.votedIPs[myFingerprint] = label;
            } else {
                // ì‹ ê·œ íˆ¬í‘œ
                roomData.poll.options[label] = (Number(roomData.poll.options[label]) || 0) + 1;
                roomData.votedIPs[myFingerprint] = label;
            }

            await set(roomRef, roomData); // ê°•ì œ ì „ì²´ ë®ì–´ì“°ê¸°ë¡œ í´ë¦­ ë³´ì¥
        };

        function renderPoll(poll, votedIPs) {
            const area = document.getElementById('poll-display-area'); area.innerHTML = "";
            const options = poll.options || {};
            const total = Object.values(options).reduce((a, b) => Number(a) + Number(b), 0);
            const myVote = votedIPs[myFingerprint]; 

            Object.entries(options).forEach(([label, count]) => {
                const per = total === 0 ? 0 : Math.round((Number(count) / total) * 100);
                const div = document.createElement('div');
                div.className = `relative h-16 rounded-2xl overflow-hidden bg-gray-50 border border-gray-100 mb-3 clickable ${myVote === label ? 'ring-2 ring-indigo-500 bg-white shadow-md' : ''}`;
                
                // â­ HTML ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆê°€ ì•„ë‹Œ ìˆœìˆ˜ JS ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¡œ ê°•ì œ í• ë‹¹ â­
                div.addEventListener('click', (e) => {
                    e.stopPropagation();
                    window.executeVote(label);
                });
                
                const countDisplay = total > 0 ? `<div class="flex items-center space-x-2 text-[11px] font-bold"><span class="text-indigo-600">${per}%</span><span class="text-gray-200 font-light">|</span><span class="text-gray-400">${count} <span class="text-[9px] opacity-70">of</span> ${total}</span></div>` : `<span class="text-gray-300 text-[11px] font-bold">0%</span>`;
                div.innerHTML = `<div class="vote-bar absolute bg-indigo-500 h-full opacity-[0.08]" style="width:${per}%"></div><div class="absolute inset-0 flex justify-between px-6 items-center font-bold pointer-events-none"><span class="${myVote === label ? 'text-indigo-700' : 'text-gray-700'} text-sm">${label}</span>${countDisplay}</div>`;
                area.appendChild(div);
            });
        }

        window.toggleMenu = () => { const m = document.getElementById('side-menu'); const o = document.getElementById('menu-overlay'); const open = m.style.transform === 'translateX(0px)'; m.style.transform = open ? 'translateX(-100%)' : 'translateX(0px)'; o.style.display = open ? 'none' : 'block'; };
        window.addOptionField = (val = "", count = 0) => { 
            const list = document.getElementById('options-list'); 
            const container = document.createElement('div');
            container.className = "flex items-center space-x-2 mb-2";
            const input = document.createElement('input'); 
            input.type = "text"; input.className = "poll-input flex-1 bg-gray-50 rounded-lg p-3 text-sm"; 
            input.placeholder = `ì„ íƒì§€ ${list.children.length + 1}`; 
            input.value = val;
            const delBtn = document.createElement('button');
            delBtn.innerHTML = "âœ•"; delBtn.className = "w-10 h-10 flex items-center justify-center bg-gray-100 text-gray-400 rounded-lg font-bold";
            delBtn.onclick = () => { if (list.children.length > 1) container.remove(); };
            container.appendChild(input); container.appendChild(delBtn); list.appendChild(container); 
        };
        window.filterByCategory = (c) => { currentCategory = c; renderList(); toggleMenu(); };
    </script>
</body>
</html>