<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>STAY - ì‹¤ì‹œê°„ ìµëª… íˆ¬í‘œ</title>

<script src="https://cdn.tailwindcss.com"></script>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body { font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; }
.clickable { cursor:pointer; }
.vote-bar { transition: width .5s ease; }
</style>
</head>

<body class="bg-white text-gray-900">

<input type="text" id="hp_nickname" style="position:absolute;left:-9999px;opacity:0">

<div id="screen-main" class="h-screen flex flex-col justify-center items-center space-y-6">
  <h1 class="text-6xl font-black italic">STAY.</h1>
  <button onclick="openCreateScreen()" class="px-6 py-4 rounded-xl bg-indigo-600 text-white font-bold">ìƒˆ íˆ¬í‘œ ë§Œë“¤ê¸°</button>
  <button onclick="goSearch()" class="px-6 py-4 rounded-xl bg-gray-100 font-bold">ì „ì²´ íˆ¬í‘œ</button>
</div>

<div id="screen-list" class="hidden min-h-screen p-4">
  <h2 class="text-xl font-black mb-4">ì „ì²´ íˆ¬í‘œ</h2>
  <div id="room-list" class="space-y-4"></div>
</div>

<div id="screen-create" class="hidden min-h-screen p-4">
  <h2 class="text-xl font-black mb-4">ìƒˆ íˆ¬í‘œ</h2>
  <input id="new-room-name" class="w-full p-3 mb-2 bg-gray-100 rounded" placeholder="ì œëª©">
  <textarea id="new-room-desc" class="w-full p-3 mb-2 bg-gray-100 rounded" placeholder="ì„¤ëª…"></textarea>
  <input id="new-room-pw" class="w-full p-3 mb-2 bg-gray-100 rounded" placeholder="ë¹„ë°€ë²ˆí˜¸">
  <div id="options-list"></div>
  <button onclick="addOptionField()" class="text-sm text-indigo-600">+ ì„ íƒì§€ ì¶”ê°€</button>
  <button onclick="processCreate()" class="w-full mt-4 bg-indigo-600 text-white py-3 rounded font-bold">ê²Œì‹œ</button>
</div>

<div id="screen-room" class="hidden min-h-screen p-4">
  <button onclick="history.back()" class="text-sm mb-2">â† ë’¤ë¡œ</button>
  <h2 id="room-title" class="text-2xl font-black"></h2>
  <p id="room-desc" class="text-gray-500 mb-6"></p>
  <div id="poll-display-area" class="space-y-3"></div>
</div>

<script>
/* ======================
   ğŸ” stay_uid (ìœ ì¼ ì‹ë³„ì)
====================== */
const STAY_UID_KEY = "stay_uid";
let myUID = localStorage.getItem(STAY_UID_KEY);
if (!myUID) {
  myUID = "u_" + Math.random().toString(36).slice(2) + Date.now();
  localStorage.setItem(STAY_UID_KEY, myUID);
}

/* ======================
   Firebase
====================== */
firebase.initializeApp({
  apiKey: "AIzaSyAgydW97uyDPNqs5VPZnSt5E-fytezqVO0",
  databaseURL: "https://project-8611780166111781402-default-rtdb.firebaseio.com"
});
const db = firebase.database();

let allRooms = [];
let currentRoomId = "";
let listDirty = false;

/* ======================
   Navigation
====================== */
function switchScreen(id) {
  document.querySelectorAll("[id^=screen-]").forEach(d => d.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
  if (id === "screen-list" && listDirty) {
    renderList();
    listDirty = false;
  }
}
function goSearch(){ switchScreen("screen-list"); renderList(); }
function openCreateScreen(){
  document.getElementById("options-list").innerHTML="";
  addOptionField(); addOptionField();
  switchScreen("screen-create");
}

/* ======================
   Data sync
====================== */
db.ref("rooms").on("value", snap=>{
  allRooms = snap.val() ? Object.entries(snap.val()) : [];
  if (!document.getElementById("screen-list").classList.contains("hidden")) renderList();
});

/* ======================
   List
====================== */
function renderList(){
  const area=document.getElementById("room-list");
  area.innerHTML="";
  allRooms.forEach(([id,room])=>{
    const total=Object.values(room.poll?.options||{}).reduce((a,b)=>a+Number(b),0);
    const div=document.createElement("div");
    div.className="p-4 bg-gray-50 rounded clickable";
    div.onclick=()=>enterRoom(id);
    div.innerHTML=`<b>${room.title}</b><div class="text-sm text-gray-400">${total} votes</div>`;
    area.appendChild(div);
  });
}

/* ======================
   Room
====================== */
function enterRoom(id){
  currentRoomId=id;
  switchScreen("screen-room");
  db.ref("rooms/"+id).on("value",snap=>{
    const d=snap.val();
    document.getElementById("room-title").innerText=d.title;
    document.getElementById("room-desc").innerText=d.desc||"";
    renderPoll(d.poll||{}, d.votedIPs||{});
  });
}

/* ======================
   Poll
====================== */
function renderPoll(poll, votedIPs){
  const area=document.getElementById("poll-display-area");
  area.innerHTML="";
  const opts=poll.options||{};
  const total=Object.values(opts).reduce((a,b)=>a+Number(b),0);
  Object.entries(opts).forEach(([label,count])=>{
    const div=document.createElement("div");
    div.className="p-4 bg-gray-100 rounded clickable";
    div.onclick=()=>vote(label);
    div.innerHTML=`${label} (${count}/${total})`;
    area.appendChild(div);
  });
}

function vote(label){
  db.ref("rooms/"+currentRoomId).transaction(room=>{
    if(!room) return room;
    room.votedIPs ||= {};
    room.poll ||= {options:{}};
    const prev = room.votedIPs[myUID];
    if(prev) room.poll.options[prev]--;
    room.poll.options[label]=(room.poll.options[label]||0)+1;
    room.votedIPs[myUID]=label;
    return room;
  });
  listDirty = true;
}

/* ======================
   Create
====================== */
function addOptionField(){
  const d=document.createElement("input");
  d.className="w-full p-2 mb-2 bg-gray-100 rounded poll-input";
  d.placeholder="ì„ íƒì§€";
  document.getElementById("options-list").appendChild(d);
}

function processCreate(){
  const title=document.getElementById("new-room-name").value.trim();
  if(!title) return alert("ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”");
  const opts={};
  document.querySelectorAll(".poll-input").forEach(i=>{
    if(i.value.trim()) opts[i.value.trim()]=0;
  });
  const id="r_"+Date.now();
  db.ref("rooms/"+id).set({
    title,
    desc:document.getElementById("new-room-desc").value,
    pw:document.getElementById("new-room-pw").value,
    poll:{options:opts},
    votedIPs:{},
    creatorFingerprint: myUID,
    createdAt:Date.now()
  }).then(()=>enterRoom(id));
}
</script>
</body>
</html>
